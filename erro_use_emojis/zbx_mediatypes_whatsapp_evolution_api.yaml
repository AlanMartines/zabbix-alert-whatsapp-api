zabbix_export:
  version: '6.4'
  media_types:
    - name: 'WhatsApp (Evolution API)'
      type: WEBHOOK
      parameters:
        - name: ApiKey
          value: <api_key>
        - name: Instance
          value: zabbixbot
        - name: Message
          value: '{ALERT.MESSAGE}'
        - name: ParseMode
          value: ""
        - name: Subject
          value: '{ALERT.SUBJECT}'
        - name: To
          value: '{ALERT.SENDTO}'
        - name: Url
          value: 'http://localhost:8080'
      attempts: '1'
      script: |
        var WhatsApp = {
            baseurl: null,
            instance: null,
            apikey: null,
            to: null,
            message: null,
            proxy: null,
            parse_mode: null,
        
            escapeMarkup: function (str, mode) {
                switch (mode) {
                    case 'markdown':
                        return str.replace(/([_*\[`])/g, '\\$&');
        
                    case 'markdownv2':
                        return str.replace(/([_*\[\]()~`>#+\-=|{}.!])/g, '\\$&');
        
                    case 'html':
                        return str.replace(/<(\s|[^a-z\/])/g, '&lt;$1');
        
                    default:
                        return str;
                }
            },
        
            sendMessage: function () {
                var params = {
                    number: WhatsApp.to,
                    options: {
                        delay: 1200,
                        presence: "composing"
                    },
                    textMessage: {
                        "text": WhatsApp.message
                    }
                },
                data,
                response,
                request = new HttpRequest(),
                url = WhatsApp.baseurl + '/message/sendText/' + WhatsApp.instance;
        
                if (WhatsApp.parse_mode !== null) {
                    params['parse_mode'] = WhatsApp.parse_mode;
                }
        
                if (WhatsApp.proxy) {
                    request.setProxy(WhatsApp.proxy);
                }
        
                request.addHeader('Content-Type: application/json');
                request.addHeader('apikey: ' + WhatsApp.apikey);
                data = JSON.stringify(params);
        
                // Remove replace() function if you want to see the exposed token in the log file.
                Zabbix.log(4, '[WhatsApp Webhook] URL: ' + url);
                Zabbix.log(4, '[WhatsApp Webhook] params: ' + data);
                response = request.post(url, data);
                Zabbix.log(4, '[WhatsApp Webhook] HTTP code: ' + request.getStatus());
        
                if (request.getStatus() == 201) {
                    // we did it. lets just exit for now.
                    Zabbix.log(4, '[WhatsApp Webhook] request sent successfully');
                    return;
                } else {
                    throw 'Unknown error. Check debug log for more information.';
                }
            }
        };
        
        try {
            var params = JSON.parse(value);
        
            if (typeof params.Url === 'undefined') {
                throw 'Incorrect value is given for parameter "Url": parameter is missing';
            }
            
            if (typeof params.Instance === 'undefined') {
                throw 'Incorrect value is given for parameter "Instance": parameter is missing';
            }
            
            if (typeof params.ApiKey === 'undefined') {
                throw 'Incorrect value is given for parameter "ApiKey": parameter is missing';
            }
        
            WhatsApp.instance = params.Instance;
            WhatsApp.baseurl = params.Url;
            WhatsApp.apikey = params.ApiKey;
        
            if (params.HTTPProxy) {
                WhatsApp.proxy = params.HTTPProxy;
            } 
        
            params.ParseMode = params.ParseMode.toLowerCase();
            
            if (['markdown', 'html', 'markdownv2'].indexOf(params.ParseMode) !== -1) {
                WhatsApp.parse_mode = params.ParseMode;
            }
        
            WhatsApp.to = params.To;
            WhatsApp.message = params.Subject + '\n' + params.Message;
        
            if (['markdown', 'html', 'markdownv2'].indexOf(params.ParseMode) !== -1) {
                WhatsApp.message = WhatsApp.escapeMarkup(WhatsApp.message, params.ParseMode);
            }
        
            WhatsApp.sendMessage();
        
            return 'OK';
        }
        catch (error) {
            Zabbix.log(4, '[WhatsApp Webhook] notification failed: ' + error);
            throw 'Sending failed: ' + error + '.';
        }
      timeout: 10s
      description: //TODO
      message_templates:
          - event_source: TRIGGERS
            operation_mode: PROBLEM
            subject: "ðŸ”´ Problem: {EVENT.NAME}"
            message: |
              ðŸ•’ Problem started: {EVENT.TIME} on {EVENT.DATE}
              ðŸš© Problem name: {EVENT.NAME}
              ðŸ’» Host: {HOST.NAME}
              ðŸš¨ Severity: {EVENT.SEVERITY}
              ðŸ” Operational data: {EVENT.OPDATA}
              ðŸ†” Original problem ID: {EVENT.ID}
              ðŸ”— {TRIGGER.URL}

          - event_source: TRIGGERS
            operation_mode: RECOVERY
            subject: "âœ… Resolved in {EVENT.DURATION}: {EVENT.NAME}"
            message: |
              â±ï¸ Problem resolved: {EVENT.DURATION} at {EVENT.RECOVERY.TIME} on {EVENT.RECOVERY.DATE}
              ðŸš© Problem name: {EVENT.NAME}
              ðŸ’» Host: {HOST.NAME}
              ðŸš¨ Severity: {EVENT.SEVERITY}
              ðŸ†” Original problem ID: {EVENT.ID}
              ðŸ”— {TRIGGER.URL}

          - event_source: TRIGGERS
            operation_mode: UPDATE
            subject: "ðŸ”„ Updated problem: {EVENT.NAME}"
            message: |
              ðŸ‘¤ {USER.FULLNAME} {EVENT.UPDATE.ACTION} problem at {EVENT.UPDATE.DATE} {EVENT.UPDATE.TIME}.
              ðŸ“ {EVENT.UPDATE.MESSAGE}

              Current problem status is {EVENT.STATUS}, acknowledged: {EVENT.ACK.STATUS}.

          - event_source: DISCOVERY
            operation_mode: PROBLEM
            subject: "ðŸ” Discovery: {DISCOVERY.DEVICE.STATUS} {DISCOVERY.DEVICE.IPADDRESS}"
            message: |
              ðŸ“¡ Discovery rule: {DISCOVERY.RULE.NAME}

              ðŸŒ Device IP: {DISCOVERY.DEVICE.IPADDRESS}
              ðŸŒ Device DNS: {DISCOVERY.DEVICE.DNS}
              ðŸ“¶ Device status: {DISCOVERY.DEVICE.STATUS}
              â³ Device uptime: {DISCOVERY.DEVICE.UPTIME}

              ðŸ› ï¸ Device service name: {DISCOVERY.SERVICE.NAME}
              ðŸšª Device service port: {DISCOVERY.SERVICE.PORT}
              ðŸ“¶ Device service status: {DISCOVERY.SERVICE.STATUS}
              â³ Device service uptime: {DISCOVERY.SERVICE.UPTIME}

          - event_source: AUTOREGISTRATION
            operation_mode: PROBLEM
            subject: "ðŸ“¥ Autoregistration: {HOST.HOST}"
            message: |
              ðŸ’» Host name: {HOST.HOST}
              ðŸŒ Host IP: {HOST.IP}
              ðŸšª Agent port: {HOST.PORT}